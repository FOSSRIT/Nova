{{extend 'csi_node.html'}}

{{if can_edit(node):}}
    <script type="text/javascript">
    $(document).ready(function() {
        $(".db_editable").each( function(){
            $(this).hover( function () {
                var edit_image=document.createElement('img');
                edit_image.src= "/csi2/static/images/edit.png";
                edit_image.alt="Edit";
                var edit_link = document.createElement("a");
                edit_link.setAttribute('href','#');
                edit_link.setAttribute('onclick',
                        'edit_request("/csi2/edit/in_place/{{=node.url}}/' + this.id + '","'+this.id+'"); return false'); 
                edit_link.setAttribute('style', 'float:left;');
                edit_link.setAttribute('title', this.title)
                edit_link.appendChild(edit_image);
                var span = document.createElement('span');
                span.setAttribute('style','position: absolute; z-index: 10000;');
                span.appendChild(edit_link)
                $(this).prepend(span);
            }, function () {
                $(this).find("span:first").remove();
            });
        });
    });

        function edit_request(url, div_loc){
 
            var div = $("#overlay");
            div.html('Loading...');
            div.show('slow');
            
            close_link = document.createElement("a");
            close_link.setAttribute('href','#');
            close_link.setAttribute('onclick','$("#overlay").hide("slow"); return false');
            close_link.innerText="Close";
            
            div.load(url, function() {
                div.append(close_link);
                var form = $("#overlay form");

                // Test if we must fake it instead
                var fakeit = false;
                $("#overlay form :input").each( function() {
                    if( this.type == "file" ){
                        fakeit = true;
                    }
                });
                
                if( fakeit == true ){
                    f_frame = document.createElement("iframe");
                    f_frame.name = "__Fake_IT_Frame";
                    f_frame.id = "__Fake_IT_Frame";
                    f_frame.style.display = "none";
                    f_frame.onload = function(){
                        if( this.contentWindow.document.body.innerHTML != "" ){
                            document.getElementById(div_loc).innerHTML=this.contentWindow.document.body.innerHTML;
                            div.hide('slow');
                        }
                        };
                    div.append(f_frame);

                    form.attr('target',"__Fake_IT_Frame");
                }else{
                    form.submit(function() {
                        var inputs = [];
                        $("#overlay form :input").each( function() {
                            inputs.push(this.name + '=' + escape(this.value));
                        });
                      
                      $.ajax({
                          data: inputs.join('&'),
                          type: 'post',
                          enctype: 'multipart/form-data',
                          url: $("#overlay form").attr('action'),
                          success: function(r) {
                              document.getElementById(div_loc).innerHTML=r;
                              div.hide('slow');
                              },
                          error: function() { alert("Failed to submit"); },
                       });
                      return false;
                    });
                }
            });
        }
    </script>
{{pass}}

{{if can_edit(node):}}
    <div class="nodeTopLinks">
        <a href="{{=URL('edit','node', args=[node.url])}}">Edit Node</a>
        <a href="{{=URL('edit','link', args=node.url)}}"  >Link Node</a>
    </div>
{{pass}}
<br />

    <div id="nodeTitle">
        <div id="name" class="db_editable">{{=node.name}}</div>
    </div> <!-- end nodeTitle -->
    
    
    <div id="picture" class="db_editable">
        {{if node.picFile:}}
        <img src="{{=URL('default','download',args=node.picFile)}}" /></a>    
        {{else:}}
        <img src="{{=URL('static', 'images', args=['placeholder.png'])}}"/></a>
        {{pass}}
    </div> <!-- end bigPic -->
     
    <div id="sideStats">
    
    <ul style="list-style-type: none; margin: 0; padding: 0;" id="at_sort">
    {{for x in node_attributes:}}
        <li>
            <div class="statTitle">{{=x.vocab.value}}</div>
            <div class="statValue"> <div id="attr_{{=x.id}}" class="db_editable">{{=MARKMIN(x.value)}}</div></div>
        </li>
    {{pass}}
    </ul>
    </div> <!-- end sideStats -->

    <div id="descriptionBox">
    <div id="description" class="db_editable">{{=MARKMIN(node.description)}}</div>
    </div> <!-- end description -->
