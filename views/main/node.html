{{extend 'csi_node.html'}}

{{if can_edit(node):}}
    <script type="text/javascript">
    function add_del_links(){
        $("a.link_link").each( function(){
            $(this).hover( function () {
                var del_image=document.createElement('img');
                del_image.src= "/csi2/static/images/delete.png";
                del_image.alt="Delete";
                del_attr_link = document.createElement("a");
                del_attr_link.setAttribute('href', '#');
                del_attr_link.setAttribute('onclick', 'delete_request("/csi2/edit/in_place/{{=node.url}}/unlink_' +
                                                       this.id + '","sidebar_container", true); return false;');
                del_attr_link.setAttribute('class', 'del_attr_link');
                del_attr_link.appendChild(del_image);
                $(this).prepend(del_attr_link);
            }, function(){
                $(this).find(".del_attr_link").remove();
            });
        });
    }
    
    function add_del_attr(){
        //Add Delete Links
        $("#at_sort .statTitle").each( function(){
            $(this).hover( function () {
                var del_image=document.createElement('img');
                del_image.src= "/csi2/static/images/delete.png";
                del_image.alt="Delete";
                del_attr_link = document.createElement("a");
                del_attr_link.setAttribute('href', '#');
                del_attr_link.setAttribute('onclick', 'delete_request("/csi2/ajaxedit/deleteattribute/{{=node.url}}/' +
                                                       this.id + '","at_sort", false); return false;');
                del_attr_link.setAttribute('class', 'del_attr_link');
                del_attr_link.appendChild(del_image);
                $(this).prepend(del_attr_link);
            }, function(){
                $(this).find(".del_attr_link").remove();
            });
        });
    }
    
    function add_edit_link( node, url_function ){
        $(node).hover( function () {
            var edit_image=document.createElement('img');
            edit_image.src= "/csi2/static/images/edit.png";
            edit_image.alt="Edit";
            var edit_link = document.createElement("a");
            edit_link.setAttribute('href','#');
            if( url_function == "" ){
                edit_link.setAttribute('onclick',
                    'edit_request("/csi2/edit/in_place/{{=node.url}}/' + node.id + '","' + node.id + '"); return false'); 
            }else{
                edit_link.setAttribute('onclick',
                    'edit_request("/csi2/ajaxedit/' + url_function + '/{{=node.url}}/' + node.id + '","' + node.id + '"); return false');
            }
            edit_link.setAttribute('style', 'float:left;');
            edit_link.appendChild(edit_image);
            var span = document.createElement('span');
            span.setAttribute('style','position: absolute; z-index: 10000;');
            span.appendChild(edit_link)
            $(node).prepend(span);
        }, function () {
            $(node).find("span:first").remove();
        });
    }
    
    $(document).ready(function() {
    
        add_del_attr();
        add_del_links();
    
        //Add New Attribute Link
        new_attr_lnk = document.createElement("a");
       
        new_attr_lnk.setAttribute('href','#');
        new_attr_lnk.setAttribute('onclick',
            'edit_request("/csi2/edit/in_place/{{=node.url}}/new_attribute","at_sort"); return false;');
        new_attr_lnk.setAttribute('id', 'add_attr_link');
        new_attr_lnk.innerText = "Add Attribute";
        $("#sideStats").prepend(new_attr_lnk);
         
        // Edit Links
        $(".db_editable").each( function(){ add_edit_link( this, "" ) });
        $(".db_attributes").each( function(){ add_edit_link( this, "editattribute" ) });
            
    });

        function delete_request(url, div_loc, lnk){
            if( confirm('Are you sure you want to delete this feild?') ){
                $.ajax({
                    url: url,
                    success: function(r) {
                        document.getElementById(div_loc).innerHTML=r;
                        if( lnk == false){
                            add_del_attr();
                        }else{
                            add_del_links();
                        }
                        //Add back the edit links
                        $(".db_attributes").each( function(){ add_edit_link( this ) });
                    },
                    error: function() { alert("Failed to submit"); },
                });
            }
        }

        function edit_request(url, div_loc){
 
            var div = $("#overlay");
            div.html('Loading...');
            div.show('slow');
            
            close_link = document.createElement("a");
            close_link.setAttribute('href','#');
            close_link.setAttribute('onclick','$("#overlay").hide("slow"); return false');
            close_link.innerText="Close";
            
            div.load(url, function() {
                div.append(close_link);
                var form = $("#overlay form");

                // Test if we must fake it instead
                var fakeit = false;
                $("#overlay form :input").each( function() {
                    if( this.type == "file" ){
                        fakeit = true;
                    }
                });
                
                if( fakeit == true ){
                    f_frame = document.createElement("iframe");
                    f_frame.name = "__Fake_IT_Frame";
                    f_frame.id = "__Fake_IT_Frame";
                    f_frame.style.display = "none";
                    f_frame.onload = function(){
                        if( this.contentWindow.document.body.innerHTML != "" ){
                            document.getElementById(div_loc).innerHTML=this.contentWindow.document.body.innerHTML;
                            div.hide('slow');
                        }
                        };
                    div.append(f_frame);

                    form.attr('target',"__Fake_IT_Frame");
                }else{
                    form.submit(function() {
                        var inputs = [];
                        $("#overlay form :input").each( function() {
                            inputs.push(this.name + '=' + escape(this.value));
                        });
                      
                      $.ajax({
                          data: inputs.join('&'),
                          type: 'post',
                          enctype: 'multipart/form-data',
                          url: $("#overlay form").attr('action'),
                          success: function(r) {
                              document.getElementById(div_loc).innerHTML=r;
                              div.hide('slow');
                                  if( div_loc == "at_sort" ){
                                      add_del_attr();
                                      $("#at_sort .db_editable").each( function(){ add_edit_link( this ) });
                                  }
                              },
                          error: function() { alert("Failed to submit"); },
                       });
                      return false;
                    });
                }
            });
        }
    </script>
{{pass}}

{{if can_edit(node):}}
    <div class="nodeTopLinks">
        <a href="{{=URL('edit','node', args=[node.url])}}">Edit Node</a>
        <a href="{{=URL('edit','link', args=node.url)}}"  >Link Node</a>
    </div>
{{pass}}
<br />

    <div id="nodeTitle">
        <div id="name" class="db_editable">{{=node.name}}</div>
    </div> <!-- end nodeTitle -->
    
    <div id="picture" class="db_editable">
        {{if node.picFile:}}
        <img src="{{=URL('default','download',args=node.picFile)}}" />
        {{else:}}
            {{if can_edit(node):}}
                <img src="{{=URL('static', 'images', args=['placeholder_edit.gif'])}}" />
            {{else:}}
                <img src="{{=URL('static', 'images', args=['placeholder.png'])}}"/>
            {{pass}}
        {{pass}}
    </div> <!-- end bigPic -->
     
    <div id="sideStats">{{include "htmlblocks/attributes.html"}}</div>

    <div id="descriptionBox">
    <div id="description" class="db_editable">{{if node.description:}}{{=MARKMIN(node.description)}}{{else:}}No Description Yet :({{pass}}</div>
    </div> <!-- end description -->
