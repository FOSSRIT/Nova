<script>
{{if request.env.http_x_forwarded_for or request.env.wsgi_url_scheme in ['https', 'HTTPS']:}}
var autoload_request_url = 'https://{{=request.env.http_host}}{{=URL('api','search.json')}}';
{{else:}}
var autoload_request_url = 'http://{{=request.env.http_host}}{{=URL('api','search.json')}}';
{{pass}}
</script>
<script>
var pending_request = "";
function pull_data(search, page, empty, full){
    request = autoload_request_url + "?order=" + $("#order").val() + "&sort=" + $("#sort").val() + "&{{=search_mode}}&page=" + page + "&search=" + escape(search);
    
    
    if( pending_request ){
        pending_request.abort();
    }
    
    if( full ){
        $("#status").html("<img src='{{=URL('static', 'images', args='lightbox_ico_loading.gif')}}'>Preforming Full Search " + search)
        request += "&fulltext=true";
    }else{
        $("#status").html("<img src='{{=URL('static', 'images', args='lightbox_ico_loading.gif')}}'>Searching " + search)
    }
    pending_request = $.getJSON(request,
        function(data){
            if( !data ){
                return;
            }
            $("#status").html('');
            if( empty ){
                $("#TARGET").empty();
            }
            $.each(data.nodes, function(key,val){
            var html_add = "\
                <div class='nodeBox'>\
                    <a href='{{=URL('main','node')}}/" + val.url + "'>\
                        <div class='nodePic'>\
                            <img class='img-ondemand' src='{{=URL('static', 'images', args='lightbox_ico_loading.gif')}}' longdesc='" +
                                ((val.picFile==""||val.picFile==null)?"{{=URL('static', 'images', args='placeholder_thumb.png')}}":"{{=URL('default','thumb',args=[150,150])}}/"+val.picFile) +"' /></div>\
                        <div class='nodeName'>" + val.name + "</div>\
                    </a>\
                 </div>";
        
            $("#TARGET").append( html_add );
        });
        imgOndemand();
        if( data.nodes.length == 50 ){
            $("#TARGET").append( "<a href='#' id='MORE_LINK' style='clear: both; text-align: center;' onclick='pull_data(\"" + escape(search) + "\", " + (page + 1) + ", false, " + full + "); $(this).remove(); return false;'><br style='clear: both;'>More</a>");

            $(window).bind("scroll.morelink", function(){
                the_link = $("#MORE_LINK");
                if( the_link.offset().top < _$w.height() + _$w.scrollTop() ){
                    $(window).unbind('scroll.morelink');
                    pull_data( search, page + 1, false );
                    the_link.remove()
                    
                }
            });
        }
    });
}

$(document).ready(function(){
    pull_data($('#search_filter').val(), 1, true, false);
});
</script>

{{if not "initial_search" in globals():}}
   {{initial_search = ""}}
{{pass}}

<div style="text-align: center;">
<form onsubmit="return false;">
    Search: <input type="text" name="search_filter" id="search_filter" onkeyup="pull_data(this.value, 1, true, false);" value="{{=initial_search}}"/>
    <select name="order" id="order" onchange="pull_data($('#search_filter').val(), 1, true, false);">
    <option value="name">Node Title</option>
    <option value="date">Creation Date</option>
    <option value="modified" selected="selected">Last Updated</option>
    </select>
    <select name="sort" id="sort" onchange="pull_data($('#search_filter').val(), 1, true, false);">
    <option value="asce">Ascending</option>
    <option value="desc" selected="selected">Descending</option>
    </select>
    <input type="button" value="Full Text Search" onclick="pull_data($('#search_filter').val(), 1, true, true);">
</form>
<div id="status"></div>
</div>
<div id="TARGET" style="clear:both;">
<img src="{{=URL('static', 'images', args='lightbox_ico_loading.gif')}}">Loading Content...
</div>
<br style="clear:both;" />
