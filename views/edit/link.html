{{extend 'csi_view.html'}}

{{if node:}}<a href="{{=URL('main','node', args=node.url)}}">Back to {{=node.name}}</a>.{{pass}}

<h2>Add or Remove Links</h2>
<script>
var links = [
{{for link in linkedSet:}}
    {{=link.id}},
{{pass}}
    ];
function set_request_url( cat ){
    {{if request.env.http_x_forwarded_for or request.env.wsgi_url_scheme in ['https', 'HTTPS']:}}
        var autoload_request_url = 'https://beta.innovation.rit.edu/csi2/main/category_ajax/' + cat;
    {{else:}}
        var autoload_request_url = 'http://beta.innovation.rit.edu/csi2/main/category_ajax/' + cat;
    {{pass}}
    
    $.getJSON( autoload_request_url,
        function(data){
            nodes = data.rows;
            display_nodes();
        }
    );
    }
    
function delete_link( page, id ){
    var url = "/csi2/ajaxedit/unlink/{{=node.url}}/" + page
    $.ajax({
        url: url,
        success: function(){
            var idx = links.indexOf(id); // Find the index
            if(idx!=-1) links.splice(idx, 1);
            display_nodes(filter_txt);
            $("div.flash").html("Node Unlinked");
            $("div.flash").slideDown('slow').delay(3000).slideUp('slow');
        },
        error: function(){
            alert("unable to link");
        }
        });
}
function create_link( page, id ){
    var url = "/csi2/ajaxedit/link/{{=node.url}}/" + page
    $.ajax({
        url: url,
        success: function(){
            links.push( id );
            display_nodes(filter_txt);
            $("div.flash").html("Node Linked");
            $("div.flash").slideDown('slow').delay(3000).slideUp('slow');
        },
        error: function(){
            alert("unable to link");
        }
        });
}
var nodes = Array();
var filter_txt="";
function display_nodes(filter){
    filter_txt = filter
    $("#TARGET").empty()
    var i = 0;
    $.each(nodes, function(key,val){
        if( filter == null || val.name.toLowerCase().indexOf(filter.toLowerCase()) != -1 && val.id != {{=node.id}}){
        var style = "";
        var action = 'create_link("' + val.url + '", ' + val.id + '); return false;';
        if(links.indexOf(val.id) != -1 ){
            var action = 'delete_link("' + val.url + '", ' + val.id + '); return false;';
            style="background: green;";
            
        }
        if( i < 9 ){
            var html_add = "\
                <div class='nodeBox' style='"+style+"'>\
                    <a href='#' onclick='" + action + "'>\
                        <div class='nodePic'>\
                            <img src='" +                                ((val.picFile==""||val.picFile==null)?"/csi2/static/images/placeholder.png":"/csi2/default/download/"+val.picFile) +
                            "' width='160px'></div>\
                        <div class='nodeName'>" + val.name + "</div>\
                    </a>\
                 </div>";
        
            $("#TARGET").append( html_add );
        }else{
            var html_add = "\
                <div class='nodeListing' style='"+style+"'>\
                     <a href='#' onclick='" + action + "'>\
                        <div class='nodeName'>" + val.name + "</div>\
                    </a>\
                 </div>";
            $("#TARGET").append( html_add );
        }
        i++;
        }
    });
}

$(document).ready(function(){
    // Grab 21 most resent modified nodes
    set_request_url('');
});
</script>

<div style="text-align: center;">
Clicking a page will add a link new link or remove an existing link.<br /> Existing links have a green frame.<br /><br />
Select Category: 
{{for category in categories:}}<a href="#" onclick="set_request_url( '{{=category.value}}' );">{{=category.value}}</a> {{pass}}
<form onsubmit="return false;">
    Filter: <input type="text" name="search_filter" onkeyup="display_nodes(this.value);" />
</form>
</div>
<div id="TARGET" style="clear:both;"><img src="{{=URL('static', 'images', args='lightbox_ico_loading.gif')}}">Loading Content...</div>
<br style="clear:both;" />
